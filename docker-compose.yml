services:
  openrouter:
    build:
      context: ./openrouter-service
      dockerfile: Dockerfile
    container_name: ares-openrouter
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-openai/gpt-3.5-turbo}
      - OPENROUTER_SERVICE_PORT=3100
    networks:
      - ares-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    volumes:
      - .:/app
      - /app/staticfiles
      # SECURITY: Docker socket removed - use Docker API with TLS for container management
      # - /var/run/docker.sock:/var/run/docker.sock
      - ./data/chromadb:/app/data/chromadb
    command: python manage.py runserver 0.0.0.0:8000
    environment:
      - ALLOWED_HOSTS=localhost,127.0.0.1,backend,aresai.space,www.aresai.space
      - DEBUG=False
      # Auth0 Configuration
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
      # Auth0 Management API (M2M) Configuration
      - AUTH0_M2M_CLIENT_ID=${AUTH0_M2M_CLIENT_ID}
      - AUTH0_M2M_CLIENT_SECRET=${AUTH0_M2M_CLIENT_SECRET}
      # Telegram
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ALLOWED_CHAT_IDS=${TELEGRAM_ALLOWED_CHAT_IDS}
      # Google Calendar OAuth Configuration
      - GOOGLE_CALENDAR_CLIENT_ID=${GOOGLE_CALENDAR_CLIENT_ID}
      - GOOGLE_CALENDAR_CLIENT_SECRET=${GOOGLE_CALENDAR_CLIENT_SECRET}
      - GOOGLE_CALENDAR_REDIRECT_URI=${GOOGLE_CALENDAR_REDIRECT_URI}
      # SD API Authentication
      - API_USERNAME=${API_USERNAME}
      - API_PASSWORD=${API_PASSWORD}
      - VITE_SD_API_URL=${VITE_SD_API_URL}
      # Ollama Configuration
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-mistral}
      # ElevenLabs TTS Configuration
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID:-21m00Tcm4TlvDq8ikWAM}
      # OpenAI Whisper STT Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # OpenRouter Service URL (TypeScript SDK wrapper)
      - OPENROUTER_SERVICE_URL=http://openrouter:3100
    depends_on:
      - openrouter
    networks:
      - ares-network

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_AUTH0_DOMAIN=${VITE_AUTH0_DOMAIN}
        - VITE_AUTH0_CLIENT_ID=${VITE_AUTH0_CLIENT_ID}
        - VITE_AUTH0_REDIRECT_URI=${VITE_AUTH0_REDIRECT_URI}
        - VITE_AUTH0_AUDIENCE=${VITE_AUTH0_AUDIENCE}
        - VITE_SD_API_URL=${VITE_SD_API_URL}
        - VITE_OLLAMA_MANAGEMENT_API_URL=${VITE_OLLAMA_MANAGEMENT_API_URL}
    container_name: ares-frontend
    ports:
      - "80:80"
      - "443:443"
    environment:
      - SD_API_URL=${VITE_SD_API_URL}
      - API_USERNAME=${API_USERNAME}
      - API_PASSWORD=${API_PASSWORD}
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
    networks:
      - ares-network

networks:
  ares-network:
    driver: bridge
