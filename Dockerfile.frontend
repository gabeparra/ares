FROM node:20-alpine AS builder

WORKDIR /app

# Accept build arguments for Vite environment variables
ARG VITE_AUTH0_DOMAIN
ARG VITE_AUTH0_CLIENT_ID
ARG VITE_AUTH0_REDIRECT_URI
ARG VITE_AUTH0_AUDIENCE
ARG VITE_SD_API_URL
ARG VITE_OLLAMA_MANAGEMENT_API_URL

# Set as environment variables for Vite build
ENV VITE_AUTH0_DOMAIN=$VITE_AUTH0_DOMAIN
ENV VITE_AUTH0_CLIENT_ID=$VITE_AUTH0_CLIENT_ID
ENV VITE_AUTH0_REDIRECT_URI=$VITE_AUTH0_REDIRECT_URI
ENV VITE_AUTH0_AUDIENCE=$VITE_AUTH0_AUDIENCE
ENV VITE_SD_API_URL=$VITE_SD_API_URL
ENV VITE_OLLAMA_MANAGEMENT_API_URL=$VITE_OLLAMA_MANAGEMENT_API_URL

# Copy package files
COPY package*.json ./

RUN npm install -g npm@11.7.0
# Install dependencies
RUN npm ci

# Copy source files
COPY . .

# Build the application
RUN npm run build

# Production stage
FROM nginx:alpine

# Copy built files from builder
COPY --from=builder /app/web/dist /usr/share/nginx/html

# Copy nginx configuration template
COPY nginx.conf.template /etc/nginx/templates/default.conf.template

# Copy SSL certificates directory structure
RUN mkdir -p /etc/nginx/ssl

EXPOSE 80 443

# Use envsubst to replace environment variables in nginx config at startup
# Base64 encode API credentials for Basic Auth (same as Telegram bot uses)
# Set SD_API_URL from environment, default to host.docker.internal:7860 if not set
CMD ["/bin/sh", "-c", "export SD_API_URL=${SD_API_URL:-http://host.docker.internal:7860} && if [ -n \"$API_USERNAME\" ] && [ -n \"$API_PASSWORD\" ]; then export SD_API_AUTH=$(echo -n \"$API_USERNAME:$API_PASSWORD\" | base64 | tr -d '\\n'); else export SD_API_AUTH=\"\"; fi && envsubst '${SD_API_URL} ${SD_API_AUTH}' < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"]

