services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    volumes:
      - .:/app
      - /app/staticfiles
    command: python manage.py runserver 0.0.0.0:8000
    environment:
      - ALLOWED_HOSTS=localhost,127.0.0.1,backend,aresai.space,www.aresai.space
      - DEBUG=True
      # Auth0 Configuration
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
      # Auth0 Management API (M2M) Configuration
      - AUTH0_M2M_CLIENT_ID=${AUTH0_M2M_CLIENT_ID}
      - AUTH0_M2M_CLIENT_SECRET=${AUTH0_M2M_CLIENT_SECRET}
    networks:
      - ares-network

  # Vite dev server (internal). Nginx (frontend) will proxy https://aresai.space -> this service.
  frontend_dev:
    build:
      context: .
      dockerfile: Dockerfile.frontend.dev
    volumes:
      - ./src:/app/src
      - ./index.html:/app/index.html
      - ./vite.config.js:/app/vite.config.js
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      - /app/node_modules
    command: npm run dev -- --host --port 3000
    environment:
      - VITE_API_URL=http://backend:8000
      - VITE_WS_URL=ws://backend:8000
      # HMR when accessed via https://aresai.space through nginx reverse-proxy
      - VITE_HMR_HOST=aresai.space
      - VITE_HMR_CLIENT_PORT=443
      - VITE_HMR_PROTOCOL=wss
      # Auth0 environment variables for Vite
      - VITE_AUTH0_DOMAIN=${VITE_AUTH0_DOMAIN}
      - VITE_AUTH0_CLIENT_ID=${VITE_AUTH0_CLIENT_ID}
      - VITE_AUTH0_REDIRECT_URI=${VITE_AUTH0_REDIRECT_URI}
      - VITE_AUTH0_AUDIENCE=${VITE_AUTH0_AUDIENCE}
    depends_on:
      - backend
    networks:
      - ares-network

  # Keep https://aresai.space working in dev by proxying to frontend_dev.
  frontend:
    image: nginx:alpine
    container_name: ares-frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
      - ./nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend_dev
    networks:
      - ares-network

networks:
  ares-network:
    driver: bridge
